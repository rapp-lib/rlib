<?php
    $var_name = $o["var_name"] ?: '$forms.entry';
    $name = $col->getName();
    $input_name = $o["name_parent"] ? $o["name_parent"]."[".$name."]" : $name;
    $is_edit = $o["is_edit"];
?>
<?php if ($col->getAttr("type")==="assoc" && $col->getAttr("def.assoc.single")): ?>
<?="\n"?>
            {{input_fieldset name="<?=$name?>" tmpl="1" key="key" assign="fieldset"}}
                <table class="tbl_admin detail">
<?php foreach ($col->getAssocTable()->getInputCols() as $assoc_col): ?>
                <tr>
                    <th><?=$assoc_col->getLabel()?></th>
                    <td class="inputBlock"><?=$assoc_col->getInputSource(array("name_parent"=>$name.'[$key]', "var_name"=>$var_name.".".$name.'[$key]'))?></td>
                </tr>
<?php endforeach; /* foreach as $assoc_col */ ?>
                </table>
            {{/input_fieldset}}
            {{foreach $fieldset.items as $item}}{{$item}}{{foreachelse}}{{$fieldset.tmpl}}{{/foreach}}
        <?=""?>
<?php elseif ($col->getAttr("type")==="assoc"): /* if type==="assoc" && def.assoc.single */ ?>
<?="\n"?>
            <div class="mi" data-minItems="0" data-maxItems="20">
                {{input_fieldset name="<?=$name?>" tmpl="<%=id%>" key="key" assign="fieldset"}}
                    <div class="mi-item" data-itemId="{{$key}}">
<?php if ($is_edit): ?>
                        {{input type="hidden" name="<?=$name?>[$key][<?=$col->getAssocTable()->getIdCol()->getName()?>]"}}
<?php endif; ?>
                        <table class="tbl_admin detail">
<?php foreach ($col->getAssocTable()->getInputCols() as $assoc_col): ?>
                        <tr>
                            <th><?=$assoc_col->getLabel()?></th>
                            <td class="inputBlock"><?=$assoc_col->getInputSource(array("name_parent"=>$name.'[$key]', "var_name"=>$var_name.".".$name.'[$key]'))?></td>
                        </tr>
<?php endforeach; /* foreach as $assoc_col */ ?>
                        <tr>
                            <th></th>
                            <td><a href="javascript:void(0);" class="mi-item-remove">削除</a></td>
                        </tr>
                        </table>
                    </div>
                {{/input_fieldset}}
                {{foreach $fieldset.items as $item}}{{$item}}{{/foreach}}
                <script type="text/template" class="mi-tmpl mi-anchor">{{$fieldset.tmpl}}</script>
                <a href="javascript:void(0);" class="mi-append">追加</a>
            </div>
            {{asset required="rui.mi"}}
        <?=""?>
<?php else: /* elseif type==="assoc" */ ?>
{{input name="<?=$input_name?>" type="<?=$col->getAttr("type")?>"<?=""?>
<? if ($enum_set = $col->getEnumSet()): ?> enum="<?=$enum_set->getFullName()?>"<?php endif; ?>
<? if ($col->getAttr("type")=="password"): ?> autocomplete="new-password"<?php endif; ?>
}}<?=""?>
<? if ($col->getAttr("type")=="file"): ?>{{if <?=$var_name?>.<?=$name?>}}<span> <a href="{{<?=$var_name?>.<?=$name?>}}" target="_blank" class="uploaded">ファイル</a> <a href="javascript:void(0);" onclick="$(this).parent().parent().find('input.uploaded').val('');$(this).parent().hide();">削除</a></span>{{/if}}<?php endif; ?>
<?php endif; /* if type==="assoc" && def.assoc.single */ ?>
