<?php
    $var_name = $o["var_name"] ?: '$forms.entry';
    $name = $o["name_parent"] ? $o["name_parent"]."[".$this->getName()."]" : $this->getName();
?>
<?php if ($col->getAttr("type")==="assoc" && $col->getAttr("def.assoc.single")): ?>
            {{input_fieldset name="<?=$name?>" tmpl="1" key="key" parent="parent" assign="fieldset"}}
                <table class="tbl_admin detail">
<?php foreach ($col->getAssocTable()->getInputCols() as $assoc_col): ?>
                <tr>
                    <th><?=$assoc_col->getLabel()?></th>
                    <td class="inputBlock"><?=$assoc_col->getInputSource(array("name_parent"=>'$parent[$key]'))?></td>
                </tr>
<?php endforeach; /* foreach as $assoc_col */ ?>
                </table>
            {{/input_fieldset}}
            {{foreach $fieldset.items as $item}}{{$item}}{{foreachelse}}{{$fieldset.tmpl}}{{/foreach}}
<?php elseif ($col->getAttr("type")==="assoc"): /* if type==="assoc" && def.assoc.single */ ?>
            <div class="mi" data-minItems="0" data-maxItems="20">
                {{input_fieldset name="<?=$col->getName()?>" tmpl="<%=id%>" key="key" parent="parent" assign="fieldset"}}
                    <div class="mi-item" data-itemId="{{$key}}">
<?php if ($controller->getAttr("type")==="master"): ?>
                        {{input type="hidden" name="$parent[$key][<?=$col->getAssocTable()->getIdCol()->getName()?>]"}}
<?php endif; ?>
                        <table class="tbl_admin detail">
<?php foreach ($col->getAssocTable()->getInputCols() as $assoc_col): ?>
                        <tr>
                            <th><?=$assoc_col->getLabel()?></th>
                            <td class="inputBlock"><?=$assoc_col->getInputSource(array("name_parent"=>'$parent[$key]'))?></td>
                        </tr>
<?php endforeach; /* foreach as $assoc_col */ ?>
                        <tr>
                            <th></th>
                            <td><a href="javascript:void(0);" class="mi-item-remove">削除</a></td>
                        </tr>
                        </table>
                    </div>
                {{/input_fieldset}}
                {{foreach $fieldset.items as $item}}{{$item}}{{/foreach}}
                <script type="text/template" class="mi-tmpl mi-anchor">{{$fieldset.tmpl}}</script>
                <a href="javascript:void(0);" class="mi-append">追加</a>
            </div>
            {{asset required="rui.mi"}}
<?php else: /* if type==="assoc" */ ?>
<?php
    $html = '{{input name="'.$name.'" type="'.$col->getAttr("type").'"';
    if ($enum_set = $col->getEnumSet()) {
        $html .=' enum="'.$enum_set->getFullName().'"';
    }
    if ($col->getAttr("type")=="password") {
        $html .=' autocomplete="new-password"';
    }
    $html .= '}}';
    if ($col->getAttr("type")=="file") {
        $html .= '{{if '.$var_name.'.'.$col->getName().'}}<span> <a href="{{'
            .$var_name.'.'.$col->getName().'}}" target="_blank" class="uploaded">ファイル</a>'
            .' <a href="javascript:void(0);" onclick="$(this).parent().parent().find(\'input.uploaded\').val(\'\');'
            .'$(this).parent().hide();">削除</a></span>{{/if}}';
    }
?>
<?=$html?>
<?php endif; /* if type==="assoc" */ ?>
