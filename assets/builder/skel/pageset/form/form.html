{{if $forms.entry->getErrors()}}
    <div class="errmsg">※入力エラーがあります</div>
    {{*
    {{foreach $forms.entry->getErrors() as $error}}
        <p class="errmsg">{{$forms.entry->getFieldLabel($error["field_name"])}} : {{$error["message"]}}</p>
    {{/foreach}}
    *}}
    {{code type="js" required=["jquery:*","app.show-errors"]}}
        $(function(){
            showErrors({
                errors: {{$forms.entry->getErrors()|json_encode}},
                $form: $("form.form-entry")
            });
        });
    {{/code}}
{{/if}}

{{form action='.'|page_to_url enctype="multipart/form-data" method="post" form=$forms.entry class="form-entry"}}
<?php if ($controller->getAttr("type")==="master"): ?>
{{input name="id" type="hidden"}}
<?php endif; ?>
<table class="tbl_admin detail">
<?php foreach ($controller->getInputCols() as $col): ?>
    <tr>
        <th><?=$col->getLabel()?></th>
<?php if ($col->getAttr("type")==="mi"): ?>
        <td>
            <div class="mi" data-minItems="0" data-maxItems="20">
                {{input_fieldset name="<?=$col->getName()?>" tmpl="<%=id%>" key="key" parent="parent" assign="fieldset"}}
                    <div class="mi-item" data-itemId="{{$key}}">
<?php if ($controller->getAttr("type")==="master"): ?>
                        {{input type="hidden" name="$parent[$key][<?=$col->getAssocTable()->getIdCol()->getName()?>]"}}
<?php endif; ?>
                        <table class="tbl_admin detail">
<?php foreach ($col->getAssocTable->getInputCols() as $assoc_col): ?>
                        <tr>
                            <th><?=$col->getLabel()?></th>
                            <td class="inputBlock"><?=$col->getInputSource(array("name_parent"=>"$parent[$key]")?></td>
                        </tr>
<?php endforeach; /* foreach as $assoc_col */ ?>
                        <tr>
                            <th></th>
                            <td><a href="javascript:void(0);" class="mi-item-remove">削除</a></td>
                        </tr>
                        </table>
                    </div>
                {{/input_fieldset}}
                {{foreach $fieldset.items as $item}}{{$item}}{{/foreach}}
                <script type="text/template" class="mi-tmpl mi-anchor">{{$fieldset.tmpl}}</script>
                <a href="javascript:void(0);" class="mi-append">追加</a>
            </div>
            {{asset required="rui.mi"}}
        </td>
<?php else: /* if type=="mi" */ ?>
        <td class="inputBlock"><?=$col->getInputSource()?></td>
<?php endif; /* if type=="mi" */ ?>
    </tr>
<?php endforeach; /* foreach as $col */ ?>
</table>
<div class="ad_btn">
    <a href='{{"<?=$pageset->getBackPage()->getFullPage($page)?>"|page_to_url:["back"=>1]}}' class="rBtn">戻る</a>
    <a href="javascript:void(0);" onclick="$(this).parents('form').trigger('submit');" class="sBtn">確認</a>
</div>
{{/form}}